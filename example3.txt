// filted wrong timestamp
SELECT DATE_ADD(unixTimestamp, timezoneOffset/60, "HOUR") as timestampLocal, *
FROM [piano-academy:riso_dataset.logs_7qx5egZQFY_201606_copy]
WHERE NOT abs(timezoneOffset) > 720 AND NOT abs(timezoneOffset) % 60 <> 0

// create articles table
SELECT url,
    COUNT(url) as clicks,
    COUNT_DISTINCT(browserId) as uniqueUsers,
    COALESCE(FIRST(UNIQUE(contentCreated)), MIN(timestampLocal)) as contentCreated,
    FIRST(LOWER(contentAuthor)) as contentAuthor,
    FIRST(LOWER(contentSection)) as contentSection,
FROM [piano-academy:riso_dataset.filteredOffset]
WHERE NOT contentAuthor is NULL AND contentAuthor <> '' 
GROUP BY url

// create data available when article is created
SELECT url, INTEGER(STRFTIME_UTC_USEC(contentCreated, "%H")) as hour,
INTEGER(STRFTIME_UTC_USEC(contentCreated, "%d")) as day, contentAuthor, contentSection, clicks
FROM [piano-academy:riso_dataset.articles]
WHERE clicks > 50
ORDER BY clicks desc

// add contentCreated to all pageViews
SELECT COALESCE(t2.contentCreated, t1.contentCreated) as contentCreated,
t2.url as url, t2.contentSection as contentSection,
t2.contentAuthor as contentAuthor, t2.browserId as browserID,
t2.timestampLocal as timestampLocal,
t2.platform as platform,
t2.rawReferrer as rawReferrer
FROM (
SELECT url,
    MIN(unixTimestamp) as contentCreated,
FROM [piano-academy:riso_dataset.filteredOffset]
WHERE NOT contentAuthor is NULL AND contentAuthor <> '' 
GROUP BY url
) t1
INNER JOIN (
SELECT *
FROM [piano-academy:riso_dataset.filteredOffset]
) t2 on t1.url = t2.url

// data available after 1 hour
SELECT
  clicks,
  firstHour,
  (ref/firstHour) as ref,
  (tablet/firstHour) as tablet,
  (mobile/firstHour) as mobile,
  (desktop/firstHour) as deskop,
  FROM (
    SELECT 
        url,
        COUNT(url) as clicks,
        SUM(CASE WHEN ((TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) < 3600*10 AND (TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) > 0) THEN 1 ELSE 0 END) as firstHour,
        SUM(CASE WHEN ((TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) < 3600*10 AND (TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) > 0 AND HOST(url) like '%'+rawReferrer+'%') THEN 1 ELSE 0 END) as ref,
        SUM(CASE WHEN ((TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) < 3600*10 AND (TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) > 0 AND platform = "desktop") THEN 1 ELSE 0 END) as desktop,
        SUM(CASE WHEN ((TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) < 3600*10 AND (TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) > 0 AND platform = "mobile") THEN 1 ELSE 0 END) as mobile,
        SUM(CASE WHEN ((TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) < 3600*10 AND (TIMESTAMP_TO_SEC(timestampLocal) - TIMESTAMP_TO_SEC(contentCreated)) > 0 AND platform = "tablet") THEN 1 ELSE 0 END) as tablet,
    FROM [piano-academy:riso_dataset.prefilteredFirstHour]
    WHERE contentAuthor <> ''
    GROUP BY url
  )
  WHERE firstHour > 5
  ORDER BY firstHour DESC
